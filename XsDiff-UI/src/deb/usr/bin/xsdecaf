#!/usr/bin/env bash
set -euo pipefail

JAR="/opt/xsdecaf/xsdecaf-ui.jar"
LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/xsdecaf"
LOG_FILE="$LOG_DIR/launch.log"
mkdir -p "$LOG_DIR"

{
  echo "[$(date -Is)] Launching xsdecaf"
  echo "JAVA: $(command -v java || echo 'not found')"
  java -version 2>&1 | sed 's/^/  /' || true
  echo "Preferred JAR: $JAR"
} >> "$LOG_FILE" 2>&1

if ! command -v java >/dev/null 2>&1; then
  zenity --error --title="xsdecaf" --text="Java runtime not found. Please install OpenJDK 11+." 2>/dev/null || true
  echo "Java runtime not found." >> "$LOG_FILE"
  exit 1
fi

# Resolve alternate jar name if default not present (e.g., versioned jar)
if [ ! -r "$JAR" ]; then
  ALT_JAR=$(ls -1 /opt/xsdecaf/xsdiff-ui-*.jar 2>/dev/null | head -n 1 || true)
  if [ -n "${ALT_JAR:-}" ] && [ -r "$ALT_JAR" ]; then
    JAR="$ALT_JAR"
    echo "Using alternate JAR: $JAR" >> "$LOG_FILE"
  fi
fi

if [ ! -r "$JAR" ]; then
  zenity --error --title="xsdecaf" --text="Jar not found. Looked for:\n  /opt/xsdecaf/xsdecaf-ui.jar\n  /opt/xsdecaf/xsdiff-ui-*.jar" 2>/dev/null || true
  echo "Jar not found at default or alternate paths." >> "$LOG_FILE"
  exit 1
fi

exec java -Dsun.awt.X11.XWMClass=xsdecaf -jar "$JAR" "$@" >> "$LOG_FILE" 2>&1 &
disown

